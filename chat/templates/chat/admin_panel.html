<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>  
    body { background: #f4f6f9; margin:0; font-family:Segoe UI,Tahoma; }
    .sidebar {
      height: 100vh; width: 250px;
      background: #111827; color: #fff; position: fixed;
      padding: 20px; overflow-y:auto;
    }
    .sidebar h2 { font-size: 1.2rem; margin-bottom: 20px; }
    .sidebar a {
      display: block; color: #fff; padding: 10px;
      text-decoration: none; margin-bottom: 10px; border-radius: 6px;
    }
    .sidebar a:hover { background: #1f2937; }
    .main-content { margin-left: 260px; padding: 20px; }
    .card { border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.1); }
    .chat-box {
      height: 400px; overflow-y: auto; background: #fff; padding: 15px;
      border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.1);
    }
    .msg { margin: 8px 0; padding:8px 12px; border-radius:8px; display:inline-block; max-width:70%; }
    .msg.admin { float:right; background:#d9fce7; color:#111; clear:both; }
    .msg.user { float:left; background:#e7f1ff; color:#111; clear:both; }
    .lead-item {
      padding:8px; margin:5px 0; border-radius:6px; background:#1f2937;
      cursor:pointer; font-size:0.9rem;
    }
    .lead-item:hover { background:#374151; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Admin Panel</h2>
    <a href="#">Dashboard</a>
    <a href="#">Visitors</a>
    <a href="#">Chats</a>
    <a href="#">Page Views</a>
    <a href="#">Settings</a>
    <hr>
    <h6>Leads</h6>
    <div id="leadList"></div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <h3 class="mb-4">Dashboard Overview</h3>
    
    <!-- Stats Cards -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="card p-3">
          <h6>Total Visitors</h6>
          <h3 id="visitorsCount">0</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <h6>Active Chats</h6>
          <h3 id="chatsCount">0</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <h6>Positive Feedback</h6>
          <h3 id="feedbackCount">0%</h3>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <h6>Page Views</h6>
          <h3 id="pageViewsCount">0</h3>
        </div>
      </div>
      <!-- âœ… Location Card Added -->
      <div class="col-md-3 mt-3">
        <div class="card p-3">
          <h6>Visitor Location</h6>
          <h3 id="locationCard">Loading...</h3>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
      <!-- Visitors Chart -->
      <div class="col-md-4 mb-4">
        <div class="card p-3">
          <h6>Visitors Historical Data</h6>
          <canvas id="visitorsChart"></canvas>
        </div>
      </div>

      <!-- Active Chats Chart -->
      <div class="col-md-4 mb-4">
        <div class="card p-3">
          <h6>Active Chats Historical Data</h6>
          <canvas id="chatsChart"></canvas>
        </div>
      </div>

      <!-- Page Views Pie Chart -->
      <div class="col-md-4 mb-4">
        <div class="card p-3">
          <h6>Page Views Distribution</h6>
          <canvas id="pageViewsChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Chat Box -->
    <div class="row">
      <div class="col-md-12">
        <div class="card p-3">
          <h6>Live Chat</h6>
          <div class="chat-box" id="chatBox">
            <p>No messages yet.</p>
          </div>
          <div class="d-flex mt-2">
            <input type="text" id="chatInput" class="form-control me-2" placeholder="Type a message...">
            <button class="btn btn-primary" id="sendBtn">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Script + API Integration -->
  <script>
    // ================== Stats & Graph Data ==================
    async function loadDashboardData(){
      try{
        const res = await fetch("/api/stats/");
        const data = await res.json();

        // Update cards
        document.getElementById("visitorsCount").innerText = data.total_visitors || 0;
        document.getElementById("chatsCount").innerText = data.total_chats || 0;
        document.getElementById("feedbackCount").innerText = (data.feedback_percent || 0) + "%";
        document.getElementById("pageViewsCount").innerText = data.page_views_total || 0;

        // Visitors Chart
        new Chart(document.getElementById('visitorsChart').getContext('2d'), {
          type: 'bar',
          data: {
            labels: data.months || [],
            datasets: [{
              label: "Visitors",
              data: data.visitors_data || [],
              backgroundColor: "#2563eb"
            }]
          },
          options:{responsive:true,scales:{y:{beginAtZero:true}}}
        });

        // Chats Chart
        new Chart(document.getElementById('chatsChart').getContext('2d'), {
          type: 'bar',
          data: {
            labels: data.months || [],
            datasets: [{
              label: "Active Chats",
              data: data.chats_data || [],
              backgroundColor: "#10b981"
            }]
          },
          options:{responsive:true,scales:{y:{beginAtZero:true}}}
        });

        // Page Views Pie (ensure data even if empty)
        const pieData = (data.page_views_dist && data.page_views_dist.length) ? data.page_views_dist : [0,0,0,0,0];
        new Chart(document.getElementById('pageViewsChart').getContext('2d'), {
          type: 'pie',
          data: {
            labels: ["Home","Products","About","Contact","Blog"],
            datasets: [{
              data: pieData,
              backgroundColor: ["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6"]
            }]
          },
          options:{responsive:true}
        });
      }catch(err){console.error("Dashboard load error:",err);}
    }

    // ================== Location Data ==================
    async function loadLocation(){
      try{
        const res = await fetch("/api/location/");
        const data = await res.json();
        if(data.city && data.country){
          document.getElementById("locationCard").innerText = data.city + ", " + data.country;
        }else{
          document.getElementById("locationCard").innerText = "Unknown";
        }
      }catch(err){
        document.getElementById("locationCard").innerText = "Error";
        console.error("Location fetch error:",err);
      }
    }

    // ================== Chat Section ==================
    let currentContactId = null;

    const chatBox = document.getElementById("chatBox");
    const msgInput = document.getElementById("chatInput");
    const sendBtn = document.getElementById("sendBtn");

    function appendMessage(sender,message,timestamp){
      const div=document.createElement("div");
      div.className="msg "+(sender.toLowerCase()==="admin"?"admin":"user");
      div.innerHTML=`${message}`;
      chatBox.appendChild(div);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    function loadMessages(contactId){
      currentContactId = contactId;
      fetch(`/api/messages/${contactId}/`).then(res=>res.json()).then(data=>{
        chatBox.innerHTML="";
        if(!data.messages || data.messages.length===0){
          chatBox.innerHTML="<p>No messages yet.</p>"; return;
        }
        data.messages.slice().reverse().forEach(m=>{
          appendMessage(m.sender||"User", m.text||"", m.timestamp||"");
        });
      }).catch(err=>{
        chatBox.innerHTML="<p>Error loading messages.</p>";
        console.error(err);
      });
    }

    function sendMessage(){
      if(!currentContactId){ alert("Select a lead first"); return; }   
      const text=msgInput.value.trim(); if(!text) return;
      appendMessage("Admin",text,"just now"); msgInput.value="";
      fetch("/api/admin-send/",{
        method:"POST", headers:{"Content-Type":"application/json"},
        body:JSON.stringify({contact_id:currentContactId,message:text})
      }).catch(err=>console.error("Send failed",err));
    }
    sendBtn.addEventListener("click",sendMessage);
    msgInput.addEventListener("keypress",e=>{ if(e.key==="Enter") sendMessage(); });

    // SSE for live chat
    const evtSource=new EventSource("/api/lead-stream/");
    evtSource.onmessage=function(event){
      try{
        const data=JSON.parse(event.data||"{}");
        if(Number(data.contact_id)===Number(currentContactId)){
          appendMessage(data.sender||"User", data.text||"[No content]", data.timestamp||"");
        }
      }catch(e){ console.error("SSE error",e); }
    };

    // ================== Lead List ==================
    function loadLeads(){
      fetch("/api/contacts/").then(res=>res.json()).then(data=>{
        const leadList=document.getElementById("leadList");
        leadList.innerHTML="";
        if(!data.contacts?.length){ 
          leadList.innerHTML="<p>No leads found.</p>"; 
          return; 
        }
        data.contacts.slice().reverse().forEach(c=>{
          const div=document.createElement("div");
          div.className="lead-item";
          div.innerText=(c.contact_value||"Unknown")+" ("+(c.contact_type||"temp")+")";
          div.onclick=()=>{ loadMessages(c.id); };
          leadList.appendChild(div);
        });
      });
    }

    // Load data on start
    loadDashboardData();
    loadLeads();
    loadLocation();
  </script>
</body>
</html>
